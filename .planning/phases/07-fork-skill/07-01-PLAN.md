# Plan 07-01: Create /fork skill

## Goal

Create the /fork skill that spawns N parallel Claude instances using mprocs, with workspace cloning for isolated experimentation.

## Context

- **Phase**: 7 of 7 - Create /fork skill
- **Milestone**: v1.2 Fork Command
- **Requirements**: FORK-03, FORK-04, FORK-05
- **Dependencies**: Phase 6 (mprocs must be available)

## Tasks

- [ ] Task 1: Create skill directory `.claude/skills/fork/`
- [ ] Task 2: Create `SKILL.md` with /fork implementation
- [ ] Task 3: Update CLAUDE.md to reference the new /fork skill
- [ ] Task 4: Test skill with sample invocation

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `.claude/skills/fork/SKILL.md` | Create | Skill that spawns parallel Claude instances |
| `CLAUDE.md` | Modify | Add /fork to available skills reference |

## SKILL.md Content

```markdown
# Fork - Parallel Claude Instances

Spawn multiple Claude instances to explore different approaches in parallel.

**Syntax**: `/fork N [prompt] [paths...]`

**Examples**:
- `/fork 3 "implement auth"` - 3 instances, same prompt, current directory
- `/fork 2 "refactor this" ./src ./lib` - 2 instances working on specific paths

---

## Prerequisites

Check if mprocs is installed:

```bash
which mprocs || echo "Install with: brew install mprocs"
```

If not installed, say: "mprocs is required for /fork. Install it with `brew install mprocs`."

---

## Implementation

### Step 1: Parse Arguments

Extract from the user's /fork command:
- `N` - Number of instances (required, 2-6)
- `prompt` - The task prompt (required)
- `paths` - Optional paths to clone (defaults to current directory)

Validate:
- N must be between 2 and 6
- Prompt must not be empty

---

### Step 2: Create Temp Workspaces

For each instance, create an isolated workspace:

```bash
# Create temp directory for this fork session
FORK_SESSION=$(mktemp -d -t fork-XXXXXX)

# For each instance 1..N:
for i in $(seq 1 $N); do
    WORKSPACE="$FORK_SESSION/instance-$i"
    mkdir -p "$WORKSPACE"

    # Clone specified paths (or current dir)
    for path in "${paths[@]:-$(pwd)}"; do
        cp -R "$path" "$WORKSPACE/"
    done
done
```

---

### Step 3: Generate mprocs.yaml

Create a mprocs configuration file:

```bash
cat > "$FORK_SESSION/mprocs.yaml" << 'EOF'
procs:
  instance-1:
    cwd: "${FORK_SESSION}/instance-1"
    shell: "claude \"${PROMPT}\""
  instance-2:
    cwd: "${FORK_SESSION}/instance-2"
    shell: "claude \"${PROMPT}\""
  # ... repeat for N instances
EOF
```

---

### Step 4: Launch mprocs

```bash
mprocs --config "$FORK_SESSION/mprocs.yaml"
```

Say: "Launching $N parallel Claude instances. Use:"
- `Tab` or number keys to switch between instances
- `q` to quit all instances
- Each instance works on its own copy of the workspace

---

### Step 5: After Completion

When mprocs exits, inform the user:

Say: "Fork session complete. Workspaces are at: $FORK_SESSION"

- `instance-1/` through `instance-N/` contain each Claude's work
- Compare results and cherry-pick the best approach
- Delete with `rm -rf $FORK_SESSION` when done

---

## Quick Reference

| Command | Description |
|---------|-------------|
| `/fork 3 "task"` | 3 instances on current dir |
| `/fork 2 "task" ./src` | 2 instances on ./src only |
| `Tab` (in mprocs) | Switch between instances |
| `q` (in mprocs) | Quit all instances |

---

## Limitations

- Maximum 6 instances (screen real estate)
- Large directories may take time to clone
- Each instance is independent (no result merging)

---

## Cleanup

Temp workspaces persist after session. To clean up:

```bash
# Remove specific session
rm -rf /tmp/fork-XXXXXX

# Remove all fork sessions
rm -rf /tmp/fork-*
```
```

## CLAUDE.md Update

Add to the Teaching section or create new section:

```markdown
## /fork - Parallel Exploration

The `/fork` skill spawns multiple Claude instances to explore different approaches in parallel.

**Usage**: `/fork N [prompt] [paths...]`

Examples:
- `/fork 3 "implement auth"` - 3 instances on current directory
- `/fork 2 "try different approaches" ./src` - 2 instances on ./src

Requires: mprocs (`brew install mprocs`)
```

## Verification

- [ ] `.claude/skills/fork/SKILL.md` exists with complete implementation
- [ ] Skill handles argument parsing (N, prompt, paths)
- [ ] Skill creates temp workspaces with cloned content
- [ ] Skill generates valid mprocs.yaml configuration
- [ ] Skill launches mprocs with proper config
- [ ] CLAUDE.md references /fork skill
- [ ] Error handling for missing mprocs

---
*Plan created: 2026-01-15*
